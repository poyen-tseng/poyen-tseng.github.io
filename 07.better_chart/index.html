<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的報表</title>

    <!-- 引入 Chart.js 庫 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <h2 style="text-align: center;">績效報表</h2>
    <p style="text-align: center;">
        <a href="index.html">績效報表</a>
        <a href="strategy.html">策略報表</a>
        <a href="aboutMe.html">關於我</a>
        <a href="aboutThisPage.html">關於這個網頁 </a>
    </p>
    <hr>
    <p>
        數值有經過一定公式的增減，不代表真實金額^_^
        <br>
        點擊折線圖上的圖標可以隱藏/顯示那條線
    </p>
    <div style="position: sticky;  height:20rem;width: 50vw; display:block; margin:auto;">
        <canvas id="myChart"></canvas>
    </div>
    <table id="tableData" style="overflow-x: auto; margin-left: auto; margin-right: auto;"></table>


    <script>
        fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vS0IEfyMkgl-wrTDQqZM2IrbS57nR0j81zYC9qQGEk-HS9Hn6Uz_ir-xAmK-_xVOkG__a16P72WupFV/pubhtml?gid=1483629649&single=true')
            .then(response => response.text())
            .then(html => {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var table = doc.querySelector('.waffle');
                table.querySelectorAll(".row-header-wrapper").forEach(table => table.remove());
                var targetElement = document.getElementById('tableData');
                targetElement.innerHTML = table.outerHTML;

                // 解析表格數據，提取時間、總資產、證券現金餘額、證券市值、期權現金餘額、期權市值
                var timeLabels = [];
                var totalAssetsData = [];
                var stockCashBalanceData = [];
                var stockValueData = [];
                var futureOptionBalanceData = [];
                var futureOptionValueData = [];

                // 遍歷表格行
                table.querySelectorAll('tr').forEach((row, index) => {
                    if (index > 0) { // 略過表頭
                        var columns = row.querySelectorAll('td');
                        var timeLabel = columns[0].textContent.trim();

                        // 排除 "test_page" 與 "時間" 元素
                        if (timeLabel !== "時間") {
                            timeLabels.push(timeLabel);
                            totalAssetsData.push(parseFloat(columns[1].textContent.trim()));
                            stockCashBalanceData.push(parseFloat(columns[2].textContent.trim()));
                            stockValueData.push(parseFloat(columns[3].textContent.trim()));
                            futureOptionBalanceData.push(parseFloat(columns[4].textContent.trim()));
                            futureOptionValueData.push(parseFloat(columns[5].textContent.trim()));
                        }
                    }
                });

                // 將陣列順序顛倒
                timeLabels.reverse();
                totalAssetsData.reverse();
                stockCashBalanceData.reverse();
                stockValueData.reverse();
                futureOptionBalanceData.reverse();
                futureOptionValueData.reverse();
                // 繪製疊圖
                var ctx = document.getElementById('myChart').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timeLabels,
                        datasets: [
                            {
                                label: '總資產',
                                yAxisID: 'percentage',
                                data: totalAssetsData,
                                borderColor: 'rgba(75, 192, 192, 1)', //66CCCC
                                borderWidth: 1,
                                fill: false
                            },
                            {
                                label: '證券現金餘額',
                                data: stockCashBalanceData,
                                borderColor: 'rgba(255, 99, 132, 1)', //FF6699
                                borderWidth: 1,
                                fill: false,
                                hidden: true
                            },
                            {
                                label: '證券市值',
                                data: stockValueData,
                                borderColor: 'rgba(54, 162, 235, 1)', //3399CC
                                borderWidth: 1,
                                fill: false,
                                hidden: true
                            },
                            {
                                label: '期權現金餘額',
                                data: futureOptionBalanceData,
                                borderColor: 'rgba(1,22,39, 1)', //011627
                                borderWidth: 1,
                                fill: false,
                                hidden: true
                            },
                            {
                                label: '期權市值',
                                data: futureOptionValueData,
                                borderColor: 'rgba(255, 159, 28, 1)', //FF9F1C
                                borderWidth: 1,
                                fill: false,
                                hidden: true
                            }
                        ]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'category',
                                labels: timeLabels
                            },
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }, {
                                id: 'percentage',
                                position: 'right',
                                ticks: {
                                    min: 0,
                                    max: 100,
                                    stepSize: 20
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Percentage'
                                }
                            }]
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: '資產變化圖',
                                font: {
                                    size: 20,
                                }
                            }
                        },
                        maintainAspectRatio: false, // 設定為 false，允許手動設定寬高

                    }
                });
            })
            .catch(error => console.error('獲取數據錯誤:', error));
    </script>

</body>

</html>